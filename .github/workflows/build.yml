name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build Debug APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
      
      # 关键调试：检查 gradlew 文件
      - name: Check gradlew file
        run: |
          echo "=== 当前目录 ==="
          pwd && ls -la
          
          echo "=== 检查 gradlew ==="
          ls -la gradlew || echo "❌ gradlew 不存在"
          file gradlew || echo "❌ 无法识别文件类型"
          head -5 gradlew || echo "❌ 无法读取文件内容"
          
          echo "=== 检查 gradle/wrapper ==="
          ls -la gradle/wrapper/ || echo "❌ wrapper 目录不存在"
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      # 关键修复：确保使用 bash 并检查命令执行
      - name: Build Debug APK
        shell: bash
        run: |
          set -x  # 显示执行的每一条命令
          echo "=== 开始构建 ==="
          
          # 检查 gradlew 是否可执行
          if [ ! -x "./gradlew" ]; then
            echo "❌ gradlew 不可执行"
            exit 1
          fi
          
          # 执行构建并捕获输出
          ./gradlew --version
          ./gradlew clean assembleDebug --stacktrace --info
        timeout-minutes: 20
      
      - name: Verify APK
        run: |
          find . -name "*.apk" -type f
          ls -la app/build/outputs/apk/debug/ 2>/dev/null || echo "目录不存在"
      
      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: app/build/outputs/apk/debug/*.apk
          retention-days: 30
